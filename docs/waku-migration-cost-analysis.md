# Next.jsからWakuへの移行コスト分析

## 概要

このドキュメントは、本プロジェクト（hello-work-job-searcher）をNext.js 16からWakuへ移行する際のコストと技術的課題を分析したものです。

## 現在のNext.js構成

### プロジェクト規模
- **ファイル数**: 49ファイル（src/app配下）
- **総コード行数**: 約647行
- **Client Components**: 11個
- **CSS Modules**: 14個

### 使用中のNext.js機能

#### 1. App Router（ファイルベースルーティング）
- `app/jobs/page.tsx` - 求人一覧ページ
- `app/jobs/layout.tsx` - パラレルルート（@search, @detail）
- `app/jobs/@detail/[jobNumber]/page.tsx` - 動的ルート
- `app/favorites/page.tsx` - お気に入りページ
- `app/history/page.tsx` - 閲覧履歴ページ

**特徴**:
- パラレルルート（Parallel Routes）を使用した2ペイン表示
- 動的ルーティング（`[jobNumber]`）

#### 2. React Server Components (RSC)
- サーバーコンポーネントとクライアントコンポーネントの明確な分離
- `"use client"`ディレクティブによる明示的な宣言
- サーバーサイドでのデータフェッチ

#### 3. エラーハンドリング
- `error.tsx` - エラーバウンダリ（Client Components必須）
- `loading.tsx` - ローディング状態の表示

#### 4. API Routes
- `app/api/[[...route]]/route.ts` - Hono統合によるAPIエンドポイント
- Vercel Edge Functionsとして動作

#### 5. その他の機能
- **Metadata API**: `export const metadata` によるSEO設定
- **CSS Modules**: コンポーネントスコープのスタイリング
- **turbopack**: 開発時のバンドラ
- **next/link**: ナビゲーション最適化

### 依存ライブラリ
```json
{
  "next": "16.1.6",
  "react": "19.2.4",
  "react-dom": "19.2.4",
  "jotai": "^2.13.1",
  "hono": "^4.8.3",
  "@tanstack/react-virtual": "^3.13.12",
  "valibot": "^1.1.0",
  "neverthrow": "^8.2.0"
}
```

## Wakuの特性

### 概要
- **作者**: Daishi Kato（Jotaiの作者）
- **ステータス**: Alpha版（2026年2月時点）
- **フォーカス**: React Server Components (RSC)のミニマル実装
- **ビルドツール**: Vite

### 主な特徴

#### 長所
1. **軽量・シンプル**: 最小限のAPIでRSCを体験
2. **Viteベース**: 高速な開発体験
3. **学習・プロトタイピング向け**: RSCの仕組みを理解しやすい
4. **Jotaiとの親和性**: 作者が同じため統合がスムーズ

#### 短所
1. **本番環境非推奨**: まだAlpha版で安定性が不十分
2. **機能が限定的**: ルーティング、ミドルウェア等を自前で構築
3. **エコシステム**: プラグインや拡張が少ない
4. **エンタープライズ機能**: ISR、i18n、画像最適化等なし

## 移行コスト分析

### 1. ルーティングシステムの再構築（高コスト）

#### 必要な作業
- **パラレルルート**: Wakuにはネイティブサポートなし
  - 2ペインレイアウト（@search, @detail）を手動実装
  - 状態管理（Jotai）でペイン表示を制御
  - 推定工数: **3-5日**

- **動的ルーティング**: 
  - Wakuのルーティングは基本的
  - `[jobNumber]`のような動的セグメントを手動実装
  - ルーターライブラリ（React Router等）の導入検討
  - 推定工数: **2-3日**

- **ファイルベースルーティング**:
  - Next.jsの規約（layout.tsx, page.tsx等）が使えない
  - すべてのルート定義を手動で実装
  - 推定工数: **2-3日**

**合計工数**: **7-11日**

### 2. APIエンドポイントの移行（中コスト）

#### 現状
- `app/api/[[...route]]/route.ts` - Hono統合

#### 移行パターン
- **Option A**: 別サーバーに分離（推奨）
  - HonoアプリをCloudflare Workersに完全分離（既存のjob-store-api）
  - フロントエンドからHTTPクライアントで呼び出し
  - **工数**: 1-2日（既に分離されているため調整のみ）

- **Option B**: Wakuに組み込み
  - Wakuでカスタムサーバー実装
  - Honoミドルウェアの統合
  - **工数**: 3-4日

**推奨**: Option A（既に分離アーキテクチャのため）
**工数**: **1-2日**

### 3. コンポーネントの移行（低〜中コスト）

#### 必要な変更
- **Client Components**: 基本的に互換性あり
  - `"use client"`ディレクティブはWakuでも使用
  - Jotai、React Virtualも動作
  - **工数**: 0.5日（動作確認のみ）

- **Server Components**: 
  - データフェッチ方法の調整
  - Wakuの規約に合わせる
  - **工数**: 1-2日

- **エラーハンドリング**:
  - `error.tsx`の仕組みがない
  - React Error Boundaryを手動実装
  - **工数**: 1日

- **loading.tsx**: 
  - ネイティブサポートなし
  - Suspenseを手動で配置
  - **工数**: 0.5日

**合計工数**: **3-4日**

### 4. スタイリングの移行（低コスト）

- **CSS Modules**: Viteが標準サポート
- **globals.css**: そのまま使用可能
- **工数**: **0.5日**（設定確認のみ）

### 5. ビルド・デプロイ設定（中コスト）

#### 必要な作業
- **Vite設定**: `vite.config.ts`の作成
- **Waku設定**: プラグイン、SSR設定
- **Vercelデプロイ**: 
  - Vercelは公式にWakuをサポート
  - ただし最適化（Edge Functions等）が限定的
  - **工数**: 1-2日

- **CI/CDパイプライン**: 
  - GitHub Actionsの調整
  - **工数**: 0.5-1日

**合計工数**: **2-3日**

### 6. 機能の再実装・代替（高コスト）

#### Metadata API
- `export const metadata`が使えない
- `<head>`タグを手動管理
- **工数**: 1日

#### 画像最適化
- `next/image`相当の機能なし
- Cloudflare Images等の外部サービス検討
- **工数**: 1-2日（導入する場合）

#### リンクのプリフェッチ
- `next/link`の最適化がない
- 手動実装またはライブラリ利用
- **工数**: 1日

**合計工数**: **3-4日**

### 7. テスト・QA（中コスト）

- **E2Eテスト**: Playwright設定の調整
- **動作確認**: 全ページ・全機能の検証
- **パフォーマンステスト**: 
- **工数**: **3-5日**

## 総コスト見積もり

| 項目 | 工数（人日） |
|-----|----------|
| ルーティング再構築 | 7-11 |
| API移行 | 1-2 |
| コンポーネント移行 | 3-4 |
| スタイリング | 0.5 |
| ビルド・デプロイ | 2-3 |
| 機能再実装 | 3-4 |
| テスト・QA | 3-5 |
| **合計** | **20-30日** |

### リスク要因（追加コスト）
- **Alpha版の不安定性**: バグ修正、回避策で+3-5日
- **ドキュメント不足**: 試行錯誤で+2-3日
- **予期しない互換性問題**: +2-5日

**最悪ケース**: **27-43日（約1-2ヶ月）**

## 移行のメリット・デメリット

### メリット
1. **軽量化**: バンドルサイズの削減
2. **学習機会**: RSCの仕組みを深く理解
3. **柔軟性**: フレームワークの制約が少ない
4. **Viteの恩恵**: 高速なHMR

### デメリット
1. **本番環境リスク**: Alpha版の使用
2. **メンテナンスコスト増**: 手動実装が多い
3. **機能損失**: Next.jsの便利機能が使えない
4. **エコシステム**: プラグイン・ツールが少ない
5. **採用リスク**: 開発者の学習コスト

## 推奨事項

### 結論: **移行は推奨しません**

#### 理由

1. **本番環境での使用は時期尚早**
   - Wakuはまだアルファ版
   - エンタープライズ向けの機能・安定性が不足
   - セキュリティアップデートの保証がない

2. **コスト対効果が低い**
   - 移行コスト: 1-2ヶ月の開発工数
   - 得られるメリット: 軽量化、学習経験
   - 失うもの: Next.jsのエコシステム、安定性、生産性向上機能

3. **現在のNext.js構成が適切**
   - App Router、RSCを既に活用
   - Vercelデプロイで最適化
   - 安定した本番環境

4. **技術的な代替手段**
   - パフォーマンス改善 → 既存の最適化手法（コード分割、キャッシュ等）
   - RSC学習 → Wakuをサイドプロジェクトで試す

### 例外: 移行を検討すべきケース

以下のいずれかに該当する場合のみ検討:

1. **学習・研究目的**
   - RSCの仕組みを深く学びたい
   - プロトタイプやサイドプロジェクト

2. **Next.jsの制約が問題**
   - 特定のユースケースでNext.jsが合わない
   - 完全なカスタマイズが必要

3. **将来的な投資**
   - Wakuの安定版（v1.0以降）リリース後
   - 本番環境実績が十分に蓄積

## 代替提案

### 1. 段階的なWaku検証（推奨）

```bash
# 新規プロジェクトで小規模に試す
pnpm create waku@latest waku-prototype
cd waku-prototype
```

- **目的**: Wakuの特性を理解
- **範囲**: 単機能のプロトタイプ
- **期間**: 1-2週間
- **リスク**: 最小限

### 2. Next.jsの最適化

現在のNext.js構成のまま、以下で改善:

- **パフォーマンス**:
  - Dynamic Imports拡大
  - Server Componentsの活用拡大
  - キャッシュ戦略の最適化

- **バンドルサイズ**:
  - 不要なライブラリの削除
  - Tree shakingの最適化
  - `@next/bundle-analyzer`で分析

### 3. 長期的な技術選定

Wakuが成熟したら再検討:

- **v1.0リリース**: 安定性の確認
- **本番環境実績**: 採用事例の調査
- **エコシステム**: プラグイン、ツールの充実度
- **再評価時期**: 2026年Q3-Q4

## まとめ

現時点でのNext.jsからWakuへの移行は、**コストが高くメリットが少ない**ため推奨しません。

- **移行コスト**: 1-2ヶ月（20-43人日）
- **主なリスク**: Alpha版の不安定性、機能損失、メンテナンスコスト増
- **推奨アクション**: 
  1. 現在のNext.js構成を維持
  2. Wakuは別プロジェクトで学習
  3. Waku安定版リリース後に再評価

本プロジェクトは、Next.js 16 + React 19 + App RouterでモダンなRSCアーキテクチャを実現しており、現時点での移行は技術的にも経済的にも合理性がありません。
